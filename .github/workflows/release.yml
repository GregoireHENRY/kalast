name: Build and Upload Release

on:
  push:
    tags:        
      - '**' 

jobs:
  release:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest] # , gregoireh-1_macos-arm64-M1]

        include:
          - os: ubuntu-latest
            PLATFORM: ubuntu
            SHELL: bashpwsh
            EXT: .exe
            OUT_EXT: .exe

          - os: macos-latest
            PLATFORM: macos-x86_64
            SHELL: bash
            EXT:
            OUT_EXT: .tar.gz

          - os: windows-latest
            PLATFORM: windows
            SHELL: pwsh
            EXT:
            OUT_EXT: .tar.gz

    steps:
    - uses: actions/checkout@v4

    - uses: dtolnay/rust-toolchain@stable
      if: ${{ matrix.os }} != 'gregoireh-1_macos-arm64-M1'

    - name: Cache Rust dependencies
      uses: actions/cache@v3
      with:
        path: target
        key: ${{ runner.os }}-build-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-build-
      if: ${{ matrix.os }} != 'gregoireh-1_macos-arm64-M1'

    - name: Get SDL2
      run: |
        if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
          sudo apt install -y libsdl2-dev
        elif [ "${{ matrix.os }}" == "macos-latest" ]; then
          brew install SDL2
        elif [ "${{ matrix.os }}" == "windows-latest" ]; then
          cp include/windows/* .
        fi
      shell: bash
      if: ${{ matrix.os }} != 'gregoireh-1_macos-arm64-M1'

    - name: Set environment
      run: |
        BUNDLE_NAME=kalast-$GITHUB_REF_NAME-$PLATFORM
        RELEASE_FILE=$BUNDLE_NAME$OUT_EXT

        echo "BUNDLE_NAME=$BUNDLE_NAME" >> "$GITHUB_ENV"
        echo "RELEASE_FILE=$RELEASE_FILE" >> "$GITHUB_ENV"
        
        echo "$PLATFORM"
        echo "$SHELL"
        echo "$BUNDLE_NAME"
        echo "$RELASE_FILE"
      shell: bash
        
    - name: Build
      run: |
        echo "Build main executable."
        cargo build -r --all-features && strip target/release/kalast$EXT

        echo "Build custom executable for specific example." 
        cargo build -r --all-features --example viewer-picker && strip target/release/examples/viewer-picker$EXT
      shell: bash
      
    - name: Bundle
      run: |
        mkdir -p bundle
        cp -r examples bundle
        cp target/release/kalast$EXT bundle
        cp target/release/examples/viewer-picker$EXT bundle/examples/viewer-picker
        cp include/kalast.ico bundle
        cp -r include/assets bundle
        cp preferences.yaml bundle
        cp README.md bundle

        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          cp include/windows/* bundle
        fi

        cd bundle
        cp -r examples/viewer/cfg .

        cd ..
        
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          cp compile/installer.iss .
          iscc installer.iss /DVERSION=0.4.0-beta /DSETUP_NAME=kalast-installer
          echo "DONE !!!"
          ls
          # mv setup.exe $RELEASE_FILE
        else
          mv bundle $BUNDLE_NAME
          tar cvzf $RELEASE_FILE $BUNDLE_NAME
        fi

    - uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.RELEASE_FILE }}
        prerelease: true